{% csrf_token %}
<!DOCTYPE html>
<html>
<head>
    <title>–§–∏–ª—å—Ç—Ä —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4">

<div class="mb-3">
    <a href="/directory/edit" class="btn btn-secondary">
        üìö –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞–º–∏
    </a>
    <a href="/transaction/create" class="btn btn-secondary">
        –°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ 
    </a>
</div>

<h2>–§–∏–ª—å—Ç—Ä —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</h2>

<form id="filterForm" class="mt-3" onsubmit="event.preventDefault(); fetchTransactions();">

    <div class="mb-2">
        <label for="category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
        <select class="form-select" id="category" onchange="loadSubCategories()">
            <option value="">-- –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é --</option>
            {% for c in categories %}
            <option value="{{ c.id }}" data-name="{{ c.name }}">{{ c.name }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="mb-2">
        <label for="sub_category">–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
        <select class="form-select" id="sub_category">
            <option value="">-- –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é --</option>
        </select>
    </div>

    <div class="mb-2">
        <label for="status">–°—Ç–∞—Ç—É—Å:</label>
        <select class="form-select" id="status">
            <option value="">-- –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å --</option>
            {% for s in statuses %}
            <option value="{{ s.id }}" data-name="{{ s.name }}">{{ s.name }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="mb-2">
        <label for="t_type">–¢–∏–ø —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:</label>
        <select class="form-select" id="t_type">
            <option value="">-- –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø --</option>
            {% for t in types %}
            <option value="{{ t.id }}" data-name="{{ t.name }}">{{ t.name }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="mb-2">
        <label for="created_at__gte">–î–∞—Ç–∞ —Å:</label>
        <input type="date" id="created_at__gte" class="form-control">
    </div>
    <div class="mb-2">
        <label for="created_at__lte">–î–∞—Ç–∞ –ø–æ:</label>
        <input type="date" id="created_at__lte" class="form-control">
    </div>

    <button type="submit" class="btn btn-primary mt-2">–ü–æ–ª—É—á–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</button>
</form>

<hr>
<h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:</h3>
<table class="table table-bordered mt-2">
    <thead>
        <tr>
            <th>ID</th>
            <th>–î–∞—Ç–∞</th>
            <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
            <th>–¢–∏–ø</th>
            <th>–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è</th>
            <th>–°—É–º–º–∞</th>
            <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
    </thead>
    <tbody id="transactions_tbl"></tbody>
</table>

<script>
const csrftoken = (() => {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith('csrftoken=')) {
                cookieValue = decodeURIComponent(cookie.substring('csrftoken='.length));
                break;
            }
        }
    }
    return cookieValue;
})();

// –ü–æ–¥–≥—Ä—É–∑–∫–∞ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π
function loadSubCategories() {
    const categoryId = document.getElementById("category").value;
    const subCatSelect = document.getElementById("sub_category");

    if (!categoryId) {
        subCatSelect.innerHTML = '<option value="">-- –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é --</option>';
        return;
    }

    fetch(`/directory/get-subcategories/${categoryId}/`)
        .then(res => res.json())
        .then(data => {
            subCatSelect.innerHTML = '<option value="">-- –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é --</option>';
            data.forEach(item => {
                subCatSelect.innerHTML += `<option value="${item.sub_category__id}" data-name="${item.sub_category__name}">${item.sub_category__name}</option>`;
            });
        })
        .catch(err => console.error(err));
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ name –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ option
function getSelectedOptionName(selectId) {
    const select = document.getElementById(selectId);
    const option = select.options[select.selectedIndex];
    return option ? option.getAttribute("data-name") : undefined;
}

// –§–∏–ª—å—Ç—Ä —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
function fetchTransactions() {
    const category = getSelectedOptionName("category") || undefined;
    const sub_category = getSelectedOptionName("sub_category") || undefined;
    const status = getSelectedOptionName("status") || undefined;
    const t_type = getSelectedOptionName("t_type") || undefined;
    const date_from = document.getElementById("created_at__gte").value || undefined;
    const date_to = document.getElementById("created_at__lte").value || undefined;

    if (date_from && date_to && date_from > date_to) {
        alert("–î–∞—Ç–∞ '—Å' –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–∑–∂–µ –¥–∞—Ç—ã '–ø–æ'");
        return;
    }

    const payload = {
        filters: { category, sub_category, status, t_type, created_at__gte: date_from, created_at__lte: date_to },
        order_by: []
    };

    fetch("/transaction/list/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrftoken
        },
        body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(data => renderTransactions(data))
    .catch(err => console.error(err));
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
function renderTransactions(data) {
    const tbody = document.getElementById("transactions_tbl");
    tbody.innerHTML = "";

    data.forEach(tx => {
        tbody.innerHTML += `
            <tr id="tx-${tx.id}">
                <td>${tx.id}</td>
                <td>${tx.created_at}</td>
                <td>${tx.category_name}</td>
                <td>${tx.status_name}</td>
                <td>${tx.t_type_name}</td>
                <td>${tx.sub_category_name}</td>
                <td>${tx.money}</td>
                <td>${tx.comment ?? ''}</td>
                <td>
                    <a href="/transaction/edit/${tx.id}" class="btn btn-sm btn-warning">
                        ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                    </a>
                </td>
            </tr>
        `;
    });
}
</script>

</body>
</html>
