{% csrf_token %}
<!DOCTYPE html>
<html>
<head>
    <title>–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4">

<a href="/" class="btn btn-secondary">
    –í–µ—Ä–Ω—É—Ç—å—Å—è –¥–æ–º–æ–π
</a>

<div class="mb-2">
    <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
    <div class="input-group">
        <input type="text" id="category" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é">
        <button class="btn btn-outline-success" onclick="addDirectoryItem('categories', 'category')">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
</div>

<div class="mb-2">
    <label>–°—Ç–∞—Ç—É—Å:</label>
    <div class="input-group">
        <input type="text" id="status" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—Ç–∞—Ç—É—Å">
        <button class="btn btn-outline-success" onclick="addDirectoryItem('statuses', 'status')">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
</div>

<div class="mb-2">
    <label>–¢–∏–ø —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:</label>
    <div class="input-group">
        <input type="text" id="t_type" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–∏–ø">
        <button class="btn btn-outline-success" onclick="addDirectoryItem('types', 't_type')">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
</div>

<div class="mb-2">
    <label>–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
    <div class="input-group">
        <input type="text" id="sub_category" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é">
        <button class="btn btn-outline-success" onclick="addDirectoryItem('subcategories', 'sub_category')">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
</div>
<hr>

<h4>–°–≤—è–∑–∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞</h4>

<div class="mb-3">
    <div class="input-group mb-2">
        <span class="input-group-text">–ö–∞—Ç–µ–≥–æ—Ä–∏—è ‚Üí –ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è</span>
        <input type="text" id="link_category" class="form-control" placeholder="–ö–∞—Ç–µ–≥–æ—Ä–∏—è">
        <input type="text" id="link_subcategory" class="form-control" placeholder="–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è">
        <button class="btn btn-success" onclick="addCatSubLink()">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
    </div>

    <div class="input-group">
        <span class="input-group-text">–ö–∞—Ç–µ–≥–æ—Ä–∏—è ‚Üí –¢–∏–ø</span>
        <input type="text" id="link_category2" class="form-control" placeholder="–ö–∞—Ç–µ–≥–æ—Ä–∏—è">
        <input type="text" id="link_type" class="form-control" placeholder="–¢–∏–ø">
        <button class="btn btn-success" onclick="addCatTypeLink()">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
</div>

<h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞–º–∏</h2>

<div id="directory-tables"></div>

<script>
const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

// –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
function loadDirectory() {
    fetch("/directory/list/")
        .then(res => res.json())
        .then(data => renderTables(data));
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü
function renderTables(data) {
    const container = document.getElementById("directory-tables");
    container.innerHTML = "";

    function tableHtml(title, items, type) {
        let html = `<h3>${title}</h3><table class="table table-bordered"><thead><tr>`;
        if (items.length > 0) {
            html += Object.keys(items[0]).map(k => `<th>${k}</th>`).join("");
        } else {
            html += "<th>ID</th><th>Name</th>";
        }
        html += "<th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead><tbody>";

        items.forEach(item => {
            let dataAttrs = `data-id="${item.id}"`; // ID —Å–∞–º–æ–π –∑–∞–ø–∏—Å–∏/—Å–≤—è–∑–∏
            if (type === 'category_sub_links') {
                dataAttrs += ` data-id1="${item.category_id}" data-id2="${item.sub_category_id}"`;
            } else if (type === 'category_type_links') {
                dataAttrs += ` data-id1="${item.category_id}" data-id2="${item.type_id}"`;
            }

            html += `<tr ${dataAttrs} data-type="${type}">`;
            for (const k in item) {
                html += `<td>${item[k]}</td>`;
            }
            html += `<td>
                <button class="btn btn-sm btn-primary" onclick="editItem('${type}', event)">‚úèÔ∏è</button>
                <button class="btn btn-sm btn-danger" onclick="deleteItem('${type}', event)">üóë</button>
            </td>`;
            html += "</tr>";
        });

        html += "</tbody></table>";
        return html;
    }

    container.innerHTML += tableHtml("–°—Ç–∞—Ç—É—Å—ã", data.statuses, "statuses");
    container.innerHTML += tableHtml("–¢–∏–ø—ã", data.types, "types");
    container.innerHTML += tableHtml("–ö–∞—Ç–µ–≥–æ—Ä–∏–∏", data.categories, "categories");
    container.innerHTML += tableHtml("–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏", data.sub_categories, "subcategories");
    container.innerHTML += tableHtml("–°–≤—è–∑—å –ö–∞—Ç–µ–≥–æ—Ä–∏—è-–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è", data.cat_sub_links, "category_sub_links");
    container.innerHTML += tableHtml("–°–≤—è–∑—å –ö–∞—Ç–µ–≥–æ—Ä–∏—è-–¢–∏–ø", data.cat_type_links, "category_type_links");
}

// –£–¥–∞–ª–µ–Ω–∏–µ
function deleteItem(type, event) {
    const row = event.target.closest("tr");
    const id = row.dataset.id;
    if (!id) return alert("ID –Ω–µ –Ω–∞–π–¥–µ–Ω!");
    if (!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã?")) return;

    fetch(`/directory/${type}/${id}/`, {
        method: "DELETE",
        headers: { "X-CSRFToken": csrftoken }
    }).then(res => {
        if (res.ok) loadDirectory();
        else alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏!");
    });
}

// –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
function editItem(type, event) {
    const row = event.target.closest("tr");
    const id = row.dataset.id; // ID —Å–∞–º–æ–π –∑–∞–ø–∏—Å–∏/—Å–≤—è–∑–∏
    if (!id) return alert("ID –Ω–µ –Ω–∞–π–¥–µ–Ω!");

    const cells = row.querySelectorAll("td");
    const originalValues = [];

    // –ü—Ä–µ–≤—Ä–∞—â–∞–µ–º –≤—Å–µ —è—á–µ–π–∫–∏ (–∫—Ä–æ–º–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π) –≤ input
    for (let i = 0; i < cells.length - 1; i++) {
        originalValues.push(cells[i].innerText);
        cells[i].innerHTML = `<input type="text" class="form-control" value="${cells[i].innerText}">`;
    }

    // –ö–Ω–æ–ø–∫–∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å / –æ—Ç–º–µ–Ω–∏—Ç—å
    cells[cells.length - 1].innerHTML = `
        <button class="btn btn-sm btn-success" onclick="saveItem('${type}', ${id}, this)">üíæ</button>
        <button class="btn btn-sm btn-secondary" onclick="cancelEdit(this, ${JSON.stringify(originalValues)})">‚ùå</button>
    `;
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
function saveItem(type, id, btn) {
    const row = btn.closest("tr");
    const inputs = row.querySelectorAll("input");
    const data = {};

    inputs.forEach((input, index) => {
        const header = input.closest("table").querySelectorAll("thead th")[index];
        const key = header.innerText;
        data[key] = input.value;
    });

    fetch(`/directory/${type}/${id}/`, {
        method: "PUT",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrftoken
        },
        body: JSON.stringify(data)
    }).then(res => {
        if (res.ok) loadDirectory();
        else alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏!");
    });
}

// –û—Ç–º–µ–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
function cancelEdit(btn, originalValues) {
    const row = btn.closest("tr");
    row.querySelectorAll("td").forEach((cell, idx) => {
        if (idx < originalValues.length) {
            cell.innerText = originalValues[idx];
        } else {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —É–¥–∞–ª–µ–Ω–∏—è
            cell.innerHTML = `
                <button class="btn btn-sm btn-primary" onclick="editItem('${row.dataset.type}', event)">‚úèÔ∏è</button>
                <button class="btn btn-sm btn-danger" onclick="deleteItem('${row.dataset.type}', event)">üóë</button>
            `;
        }
    });
}

//–§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞, –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏, —Ç–∏–ø–∞
function addDirectoryItem(type, inputId) {
    const value = document.getElementById(inputId).value.trim();
    if (!value) return alert("–í–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ!");

    fetch(`/directory/${type}/`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrftoken
        },
        body: JSON.stringify({name: value})
    })
    .then(res => {
        if (!res.ok) throw new Error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏!");
        return res.json();
    })
    .then(data => {
        alert(`–î–æ–±–∞–≤–ª–µ–Ω–æ: ${data.name}`);
        document.getElementById(inputId).value = "";
    })
    .catch(err => alert(err.message));
}

//–§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–≤—è—â–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏-–ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏
function addCatSubLink() {
    const category = document.getElementById("link_category").value.trim();
    const sub = document.getElementById("link_subcategory").value.trim();

    if (!category || !sub) {
        return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±–∞ –ø–æ–ª—è!");
    }

    fetch(`/directory/category_sub_links/`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrftoken
        },
        body: JSON.stringify({
            category: category,
            sub_category: sub
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
        } else {
            alert(`‚úÖ –°–≤—è–∑–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞: ${category} ‚Üí ${sub}`);
            document.getElementById("link_category").value = "";
            document.getElementById("link_subcategory").value = "";
        }
    });
}

//–§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–≤—è—â–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏-—Ç–∏–ø–∞
function addCatTypeLink() {
    const category = document.getElementById("link_category2").value.trim();
    const type = document.getElementById("link_type").value.trim();

    if (!category || !type) {
        return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±–∞ –ø–æ–ª—è!");
    }

    fetch(`/directory/category_type_links/`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrftoken
        },
        body: JSON.stringify({
            category: category,
            t_type: type
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
        } else {
            alert(`‚úÖ –°–≤—è–∑–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞: ${category} ‚Üí ${type}`);
            document.getElementById("link_category2").value = "";
            document.getElementById("link_type").value = "";
        }
    });
}


// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
loadDirectory();
</script>

</body>
</html>
